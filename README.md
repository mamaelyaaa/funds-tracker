# Трекер капитала

Система для отслеживания личного капитала и доходов

## Функционал

- **Управление счетами**: Создание/Редактирование
    - Ручное обновление баланса: Списания, пополнения
    - Расчет чистого капитала: Подсчет прибыли со всех активов
- **Аналитика и визуализация**:
    - Динамика по счетам: Отдельный график, показывающий движение средств на конкретном счете.
- **Цели и накопление**:
    - Установка финансовой цели
    - Отслеживание прогресса

## Архитектура

- **Базы данных**
    - Основное хранение всех данных
- **Брокер сообщений**
    - Агрегация и расчет общего капитала: после обновление баланса счета идет задача в брокер и она обновляет общий
      капитал
    - Задачи по расписанию для "скриншотов" истории: например для дальнейшей аналитики
    - Scheduler в ТГ для напоминаний об обновлении счетов
    - Советник, чтобы снизить проценты
- **Кеш**:
    - Хранение **горящих балансов**, чтобы не подгружать их каждый раз
    - Лимит запросов

___

## Архитектурный стек

- БД (PostgreSQL):
    - Хранилище «правды» (счета, история балансов, цели).

- Кэш (Redis):
    - Актуальные остатки для мгновенного отображения, черновики распределения денег, идемпотентность.

- Брокер (RabbitMQ):
    - Фоновые задачи (аналитика, напоминания, расчет «советов»).

## Функциональные модули MVP

**Модуль А: Управление капиталом (Core)**

- Счета: Создание счетов с указанием валюты и типа.
- Snapshot Update: Ручной ввод текущего остатка. Система не просит транзакции, она просто записывает: «На 27.01.2026 на
  счету X стало 500 000 руб».
- Дельта-анализ: Брокер после обновления считает разницу с предыдущим месяцем и записывает её как «Доход за период».

**Модуль Б: Распределение по целям (Smart Distribution)**

- Сферы накопления: Пользователь создает цели (Подушка, Инвестиции, Отпуск) и задает им % от прихода.
- Draft-расчет (Redis): Когда вводишь сумму, система в Redis показывает: «Из твоих 100к мы предлагаем разложить: 20к —
  Подушка, 40к — Инвестиции...».
- Фиксация: После подтверждения балансы целей в БД обновляются.

**Модуль В: Бизнес-блок (B2B Lite)**

- Чистая прибыль: Если счет помечен как «Бизнес», система при вводе остатка спрашивает про «вливания» личных средств,
  чтобы отделить реальный доход бизнеса от твоих дозаправок.
- Отчет Cash Flow: Простая агрегация: сколько денег «зашло» на бизнес-счета за месяц.

**Модуль Г: Умный советник (Behavioral Logic)**

- Контроль списаний: Если ты вводишь остаток меньше предыдущего на счете «Инвестиции» (с которого не планировал
  снимать), система инкрементирует счетчик нарушений в Redis.
- Рекомендация: Если нарушений > 2, брокер создает событие-совет: «Кажется, 40% на инвестиции — это много для тебя,
  давай снизим до 30%, чтобы ты не снимал оттуда?».

## Схема БД

- **Пользователи** `Users`: базовое хранение пользователей (id, name)
- **Счета пользователей** `Accounts`: (id, user_id, name, type, balance, currency, is_for_saving BOOL)
- **История счетов** `BalanceHistory`: обновляемая таблица для аналитики (id, account_id, date, balance_val)
- **Цели для накопления**: `SavingGoals`: привязанная цель к счету, либо просто пользователю, (id, user_id, account_id
  NULL, name, percent, target, current) 