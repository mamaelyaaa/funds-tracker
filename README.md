# Трекер капитала

Система для отслеживания личного капитала и доходов

## Запуск

### Воркер

```shell
cd src
taskiq worker infra:broker -fsd -tp infra.tasks --ack-type when_executed -w 1
```

## Функционал

- **Управление счетами**: Создание/Редактирование
    - Ручное обновление баланса: Списания, пополнения
    - Расчет чистого капитала: Подсчет прибыли со всех активов
- **Аналитика и визуализация**:
    - Динамика по счетам: Отдельный график, показывающий движение средств на конкретном счете.
- **Цели и накопление**:
    - Установка финансовой цели
    - Отслеживание прогресса

## Архитектура

- **Базы данных**
    - Основное хранение всех данных
- **Брокер сообщений**
    - Агрегация и расчет общего капитала: после обновление баланса счета идет задача в брокер и она обновляет общий
      капитал
    - Задачи по расписанию для "скриншотов" истории: например для дальнейшей аналитики
    - Scheduler в ТГ для напоминаний об обновлении счетов
    - Советник, чтобы снизить проценты
- **Кеш**:
    - Хранение **горящих балансов**, чтобы не подгружать их каждый раз
    - Лимит запросов

___

## Архитектурный стек

- БД (PostgreSQL):
    - Хранилище «правды» (счета, история балансов, цели).

- Кэш (Redis):
    - Актуальные остатки для мгновенного отображения, черновики распределения денег, идемпотентность.

- Брокер (RabbitMQ):
    - Фоновые задачи (аналитика, напоминания, расчет «советов»).

## Функциональные модули MVP

**Модуль А: Управление капиталом (Core)**

- Счета: Создание счетов с указанием валюты и типа.
- Snapshot Update: Ручной ввод текущего остатка. Система не просит транзакции, она просто записывает: «На 27.01.2026 на
  счету X стало 500 000 руб».
- Дельта-анализ: Брокер после обновления считает разницу с предыдущим месяцем и записывает её как «Доход за период».

**Модуль Б: Распределение по целям (Smart Distribution)**

- Сферы накопления: Пользователь создает цели (Подушка, Инвестиции, Отпуск) и задает им % от прихода.
- Draft-расчет (Redis): Когда вводишь сумму, система в Redis показывает: «Из твоих 100к мы предлагаем разложить: 20к —
  Подушка, 40к — Инвестиции...».
- Фиксация: После подтверждения балансы целей в БД обновляются.

**Модуль В: Умный советник (Behavioral Logic)**

- Контроль списаний: Если ты вводишь остаток меньше предыдущего на счете «Инвестиции» (с которого не планировал
  снимать), система инкрементирует счетчик нарушений в Redis.
- Рекомендация: Если нарушений > 2, брокер создает событие-совет: «Кажется, 40% на инвестиции — это много для тебя,
  давай снизим до 30%, чтобы ты не снимал оттуда?».

## Схема БД

- **Пользователи** `Users`: базовое хранение пользователей (id, name)
- **Счета пользователей** `Accounts`: (id, user_id, name, type, balance, currency, is_for_saving BOOL)
- **История счетов** `BalanceHistory`: обновляемая таблица для аналитики (id, account_id, date, balance_val)
- **Цели для накопления**: `SavingGoals`: привязанная цель к счету, либо просто пользователю, (id, user_id, account_id
  NULL, name, percent, target, current) 


## Функционал

### Расчет дохода и капитала пользователя

1. Пользователь создает счёт с изначальным балансом **1000 рублей**
2. Пользователь спустя время обновляет баланс счёта на **1500 рублей**
3. Система сравнивает текущий счёт с предыдущим за период 
   - Период `Месяц`: Система ищет в истории крайний баланс за предыдущий месяц и сравнивает его с текущим 
   - Период `За все время`: Показывается разница между текущим счётом и первоначальным. Без процентов 

### История аккаунтов 

#### Создание и обновление 

1. Пользователь создает счёт с изначальным балансом **1000 рублей**
2. Система сохраняет баланс в истории `[1000]`
3. Пользователь обновляет счёт на **1500**
   - Если в этот же день: Система перезаписывает историю за текущий день `[1500]`
   - Если позже: Система добавляет новую запись в историю `[1000, 1500]`

#### Получение и отображение

1. Система дает   